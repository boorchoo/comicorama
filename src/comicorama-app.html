<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/app-route/app-location.html">
<link rel="import" href="../../bower_components/app-layout/app-header-layout/app-header-layout.html">
<link rel="import" href="../../bower_components/app-layout/app-header/app-header.html">
<link rel="import" href="../../bower_components/app-layout/app-scroll-effects/app-scroll-effects.html">
<link rel="import" href="../../bower_components/app-layout/app-toolbar/app-toolbar.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animated-pages.html">
<link rel="import" href="../../bower_components/neon-animation/neon-animations.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">

<link rel="import" href="comicorama-page-selector-behavior.html">
<link rel="import" href="comicorama-user-behavior.html">

<link rel="import" href="comicorama-styles.html">

<link rel="import" href="comicorama-home-page.html">
<link rel="import" href="comicorama-about-page.html">
<link rel="import" href="comicorama-series-page.html">
<link rel="import" href="comicorama-authors-page.html">
<link rel="import" href="comicorama-books-page.html">
<link rel="import" href="comicorama-book-page.html">

<dom-module id="comicorama-app">
  <template>
    <style include="comicorama-styles iron-flex iron-flex-alignment iron-positioning">
      :host {
        display: block;
      }

      app-header {
        height: 6rem;
        background-color: white;
      }

      app-header app-toolbar {
        height: 6rem;
      }

      app-header app-toolbar img.logo {
        width: var(--comicorama-logo-width);
        padding-top: 8px;
      }

      app-header app-toolbar div.main-title {
        padding-left: var(--comicorama-horizontal-padding);
        overflow: hidden;

        @apply(--comicorama-font-title1);
      }

      neon-animated-pages {
        overflow: hidden;
      }

      #intro {
        @apply(--layout-fit);
        @apply(--layout-vertical);
        @apply(--layout-center-justified);
        background-color: var(--comicorama-background-color);
        opacity: 1;
        transition: opacity 1s;
      }

      #exlibris {
        @apply(--layout-self-center);
      }

      @media only screen and (orientation: portrait) {
        app-header app-toolbar img.logo {
          width: var(--comicorama-logo-width-small-screen);
        }

        app-header app-toolbar div.main-title {
          font-size: var(--comicorama-font-size-title1-small-screen);
        }
      }

      #userContainer {
        @apply(--layout-vertical);
        @apply(--layout-center-justified);
        opacity: 1;
        transition: opacity 1s;
      }

      #userContainer.not-ready {
        visibility: hidden;
        opacity: 0;
      }

      #userContainer .sign-in {
        @apply(--comicorama-font-title);
        color: var(--comicorama-base-color);
        transition: color 0.5s;
        cursor: pointer;
      }

      #userContainer .sign-in:hover {
        color: var(--comicorama-accent-color);
      }

      #userContainer .user {
        @apply(--layout-vertical);
        @apply(--layout-center-justified);
      }

      #userContainer .user iron-image {
        @apply(--layout-self-center);
        width: 48px;
        height: 48px;
        border-radius: 24px;
        cursor: pointer;
      }
    </style>

    <app-location route="{{route}}"></app-location>
    
    <app-route route="{{route}}" pattern="/books" tail="{{booksRoute}}"></app-route>
    <app-route route="{{route}}" pattern="/book" tail="{{bookRoute}}"></app-route>
    <!-- NOTE: We have to set subroutes before setting main route to avoid showing old data -->
    <app-route route="{{route}}" pattern="/:page" data="{{routeData}}"></app-route>

    <app-header-layout fullbleed has-scrolling-region>
      <app-header fixed shadow="{{page.scrolled}}">
        <app-toolbar>
          <a href="/home" alt=""><img src="/img/comicorama-logo.png" class="logo"/></a>
          <div main-title class="main-title">{{mainTitle}}</div>
          <div id="userContainer">
            <div class="sign-in" hidden="[[user]]" on-tap="login">Sign in</div>
            <div class="user" hidden="[[!user]]" on-tap="logout">
              <iron-image src="[[user.picture]]" preload fade sizing="cover"></iron-image>
            </div>
          </div>
        </app-toolbar>
      </app-header>
      <neon-animated-pages id="pages"
        class="fit"
        attr-for-selected="id"
        selected="{{routeData.page}}"
        selected-item="{{page}}"
        fallback-selection="home">
        <comicorama-home-page id="home"></comicorama-home-page>
        <comicorama-about-page id="about"></comicorama-about-page>
        <comicorama-series-page id="series"></comicorama-series-page>
        <comicorama-authors-page id="authors"></comicorama-authors-page>
        <comicorama-books-page id="books" route="{{booksRoute}}"></comicorama-books-page>
        <comicorama-book-page id="book" route="{{bookRoute}}"></comicorama-book-page>
      </neon-animated-pages>
    </app-header-layout>

    <div id="intro" hidden="[[!intro]]">
      <object id="introObject" type="image/svg+xml" data="/img/comicorama-exlibris.svg"></object>
    </div>
  </template>

  <script>
    Polymer({
      is: 'comicorama-app',
      behaviors: [
        ComicoramaPageSelectorBehavior,
        ComicoramaUserBehavior
      ],
      observers: [
        '_onUserChanged(user)'
      ],
      listeners: {
        'comicorama-change-route': '_onChangeRoute',
        'comicorama-change-app-header': '_onChangeAppHeader'
      },
      _onUserChanged: function (user) {
        this.toggleClass('not-ready', user === false, this.$.userContainer);
      },
      _onChangeRoute: function (e) {
        this.set('route.path', e.detail.path);
      },
      _onChangeAppHeader: function () {
        if (this.page && typeof this.page.title === 'string' && this.mainTitle !== this.page.title) {
          this.set('mainTitle', this.page.title);
        }
        this.notifyPath('page.scrolled');
      },
      ready: function () {
        this.intro = false;
      },
      attached: function () {
        var introObject = document.getElementById('introObject');
		    introObject.addEventListener('load', function() {
			    var svg = introObject.getSVGDocument();
			    var delay = 0.25;
			    var groups = ['books1', 'books4', 'books2', 'books3', 'bookshelf', 'row1', 'row2', 'row3'];

          svg.getElementById('book').style.opacity = '0';
          svg.getElementById('tatjana').style.opacity = '0';
			    for (var i in groups) {
				    svg.getElementById(groups[i]).style.opacity = '0';
			    }

			    setTimeout(function () {
				    svg.getElementById('book').style.transition = 'opacity 1s 0s';
            svg.getElementById('tatjana').style.transition = 'opacity 1s 0s';
				    svg.getElementById('book').style.opacity = '1';
            svg.getElementById('tatjana').style.opacity = '1';
				    for (var i in groups) {
					    svg.getElementById(groups[i]).style.transition = 'opacity ' + delay + 's ' + (1 + i * delay) + 's';
					    svg.getElementById(groups[i]).style.opacity = '1';
				    }
			    }, 0);
		    });

        this.async(function () {
          this.$.intro.style['opacity'] = '0';
          this.async(function () {
            this.intro = false;
          }, 1000);
        }, 5000);
      }
    });
  </script>
</dom-module>